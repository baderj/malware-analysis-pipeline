import json
import redis

from utils.state import State

class Task:

    def __init__(self, task_id, plugins_count):
        self.task_id = task_id
        self.progress = 0
        self.plugins_count = plugins_count
        self.error = False
        self._update_task()

    @staticmethod
    def _load_redis() -> None:
        Task.redis = redis.Redis(host=State.config['redis']['host'], port=State.config['redis']['port'], db=0)  
        Task.redis.flushall()

    def adavance_progress(self):
        self.progress += 1
        self._update_task()

    def set_error(self):
        self.error = True
        self._update_task()

    def _update_task(self):
        data = json.dumps({"task_id": self.task_id, 
                           "sample_name": State.attachment_name, 
                           "progress": self.progress, 
                           "total_progress": self.plugins_count,
                           "error": self.error})
        Task.redis.set(str(self.task_id), data)

Task._load_redis()